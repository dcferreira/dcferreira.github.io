<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.4.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=description content="How to use multi-stage building in Docker to containerize a hatch project with a web app."><link rel=alternate hreflang=en-us href=https://dcferreira.com/post/2023-03-06-ai-web-app/><meta name=theme-color content="hsl(339, 90%, 68%)"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.ad6ecacece4e570505517f526b6aa54a.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-137896487-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","UA-137896487-1",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://dcferreira.com/post/2023-03-06-ai-web-app/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@dcferreira1"><meta property="twitter:creator" content="@dcferreira1"><meta property="og:site_name" content="Daniel C Ferreira <dcferreira>"><meta property="og:url" content="https://dcferreira.com/post/2023-03-06-ai-web-app/"><meta property="og:title" content="Making and Deploying an AI Web App in 2023 (Part 6) | Daniel C Ferreira <dcferreira>"><meta property="og:description" content="How to use multi-stage building in Docker to containerize a hatch project with a web app."><meta property="og:image" content="https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_512x512_fill_lanczos_center_3.png"><meta property="twitter:image" content="https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2023-03-08T00:06:00+00:00"><meta property="article:modified_time" content="2023-03-08T00:06:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://dcferreira.com/post/2023-03-06-ai-web-app/"},"headline":"Making and Deploying an AI Web App in 2023 (Part 6)","datePublished":"2023-03-08T00:06:00Z","dateModified":"2023-03-08T00:06:00Z","author":{"@type":"Person","name":"Daniel C. Ferreira"},"publisher":{"@type":"Organization","name":"Daniel C Ferreira \u003cdcferreira\u003e","logo":{"@type":"ImageObject","url":"https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_192x192_fill_lanczos_center_3.png"}},"description":"How to use multi-stage building in Docker to containerize a hatch project with a web app."}</script><title>Making and Deploying an AI Web App in 2023 (Part 6) | Daniel C Ferreira &lt;dcferreira></title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class="page-wrapper dark" data-wc-page-id=e5c56e263fcf91f851c2311ea5982848><script src=/js/wowchemy-init.min.6c07fd79b08c404df0504bd310968f2f.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#experience><span>Experience</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Making and Deploying an AI Web App in 2023 (Part 6)</h1><p class=page-subtitle>Containerize an App with Docker</p><div class=article-metadata><div></div><span class=article-date>Mar 8, 2023</span>
<span class=middot-divider></span>
<span class=article-reading-time>3 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/ai/>AI</a>, <a href=/category/nlp/>NLP</a></span></div></div><div class=article-container><div class=article-style><div class="alert alert-note"><div>This is part of a multi-part blogpost about how to build an AI Web App.
Please refer to <a href=/post/2023-03-01-ai-web-app>Part 1</a> for more context.</div></div><p>Now that your web app is working locally, it&rsquo;s time to think about deploying it somewhere.
The easiest way to do that is to make a Docker image, and send it to wherever you want to deploy it.
Having a docker image guarantees that your environment is replicable wherever you take it.</p><h1 id=build-a-docker-image>Build a Docker Image</h1><p>In our app, we have a 2-stage process: first we build our Python package into a <a href=https://pythonwheels.com/ target=_blank rel=noopener>wheel file</a>,
and then we run the web server.
Therefore, we can use Docker&rsquo;s <a href=https://docs.docker.com/build/building/multi-stage/ target=_blank rel=noopener>multi-stage build feature</a>.
Having this process split into 2 stages enables us to have a minimalist Python environment in the final image.
That is, we install the dev environment in the first stage, but only the minimal needed dependencies in the final image.</p><p>This is our <code>Dockerfile</code>, which should be in the root of our project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.10 AS builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># install hatch</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir --upgrade hatch<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . /code<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># build python package</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /code</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> hatch build -t wheel<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.10</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># copy wheel package from stage 1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /code/dist /code/dist<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir --upgrade /code/dist/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># copy the serving code and our database</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> app.py /code<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> articles.sqlite /code<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># run web server</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /code</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;uvicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;app:app&#34;</span><span class=p>,</span> <span class=s2>&#34;--host&#34;</span><span class=p>,</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=s2>&#34;--port&#34;</span><span class=p>,</span> <span class=s2>&#34;8080&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><div class="alert alert-warning"><div>If your project directory contains many files (or some big ones), building this image might take a long time.
If that is the case, you should make a <code>.dockerignore</code> file to avoid having docker run through all your files.
See more about this in <a href=https://docs.docker.com/engine/reference/builder/#dockerignore-file target=_blank rel=noopener>Docker&rsquo;s docs</a>.</div></div><p>To simplify our workflow, we should also add a couple of scripts to our <code>pyproject.toml</code>, to build and run our
docker image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>tool</span><span class=p>.</span><span class=nx>hatch</span><span class=p>.</span><span class=nx>envs</span><span class=p>.</span><span class=nx>default</span><span class=p>.</span><span class=nx>scripts</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>build</span> <span class=p>=</span> <span class=s2>&#34;docker buildx build . -t ai-web-app:latest&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>serve-docker</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;docker run -p 5000:8080 ai-web-app:latest&#34;</span><span class=p>]</span>
</span></span></code></pre></div><p>You can then run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hatch run build
</span></span></code></pre></div><p>and the docker image will be built.
Afterwards, you should run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hatch run serve-docker
</span></span></code></pre></div><p>which will serve the app in your local port <code>5000</code>.</p><p>You can again test with curl, by running this command in a new terminal window:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X GET <span class=s2>&#34;http://127.0.0.1:5000/search?query=symptoms%20of%20covid&#34;</span>
</span></span></code></pre></div><p>This request should get the same result as the one in <a href=/post/2023-03-05-ai-web-app>Part 5</a></p><div class="alert alert-note"><div>If you&rsquo;ve been following these instructions, your code should look like this:
<a href=https://github.com/dcferreira/ai-web-app/tree/1a9b73f17d99536801e6672d6161056d71fa44b4 target=_blank rel=noopener>https://github.com/dcferreira/ai-web-app/tree/1a9b73f17d99536801e6672d6161056d71fa44b4</a></div></div><h1 id=optional-optimize-the-image>[Optional] Optimize the Image</h1><p>In this case, the container startup is taking around 2 minutes in my machine.
That could be fine if we&rsquo;re deploying the image in our own premises, and we just start it up once and it will running.
However, we want to deploy it to some serverless provider, which means the container will need to startup
from scratch more or less for each request.</p><p>Therefore, we should have a look at what we can do to minimize this startup time.
In our app, every time the container starts, the database is being indexed.
Another thing that takes time is downloading the <code>all-MiniLM-L6-v2</code> model (see <a href=/post/2023-03-02-ai-web-app>Part 2</a>),
which is also happening every time the container starts.</p><p>There is an easy fix in this case: since the model and the database will be the same for all containers
we launch, we should just move these 2 steps to the build process.
The build process will then take a bit more time, but the startup will be almost instant.</p><p>Indeed this is <a href=https://github.com/dcferreira/ai-web-app/commit/92099b561bc4e8db3d567244cebf2e7eb1a2df56 target=_blank rel=noopener>what we did in this commit</a>.
After doing those optimizations, the startup is now almost instant.</p><p>To continue this tutorial, go to <a href=/post/2023-03-07-ai-web-app>Part 7</a>.</p></div><div class=article-tags><a class="badge badge-light" href=/tag/ai/>AI</a>
<a class="badge badge-light" href=/tag/machine-learning/>Machine Learning</a>
<a class="badge badge-light" href=/tag/web-app/>Web App</a>
<a class="badge badge-light" href=/tag/txtai/>txtai</a>
<a class="badge badge-light" href=/tag/web-development/>Web Development</a>
<a class="badge badge-light" href=/tag/serverless/>Serverless</a>
<a class="badge badge-light" href=/tag/nlp/>NLP</a></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.3d946de2e8784a477845261d87025092.js></script>
<script src=https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/latex.min.js crossorigin=anonymous></script>
<script id=search-hit-fuse-template type=text/x-template>
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.e8fd2d733eef6a8bbbe0539398fc0547.js type=module></script>
<script src=/en/js/wowchemy.min.9162604ef5b82e6fdeff386200ab6db9.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.b0d291ed6d27eacec233e6cf5204f99a.js type=module></script></body></html>