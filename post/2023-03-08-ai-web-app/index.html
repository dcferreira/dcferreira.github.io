<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.4.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><meta name=description content="How to deploy a serverless AI app to Google Cloud almost for free using Cloud Run and the Artifact Registry."><link rel=alternate hreflang=en-us href=https://dcferreira.com/post/2023-03-08-ai-web-app/><meta name=theme-color content="hsl(339, 90%, 68%)"><link rel=stylesheet href=/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css integrity="sha512-W0xM4mr6dEP9nREo7Z9z+9X70wytKvMGeDsj7ps2+xg5QPrEBXC8tAW1IFnzjR6eoJ90JmCnFzerQJTLzIEHjA==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/github.min.css crossorigin=anonymous title=hl-light media=print onload='this.media="all"' disabled><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/styles/dracula.min.css crossorigin=anonymous title=hl-dark media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.ad6ecacece4e570505517f526b6aa54a.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-137896487-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","UA-137896487-1",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_180x180_fill_lanczos_center_3.png><link rel=canonical href=https://dcferreira.com/post/2023-03-08-ai-web-app/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@dcferreira1"><meta property="twitter:creator" content="@dcferreira1"><meta property="og:site_name" content="Daniel C Ferreira <dcferreira>"><meta property="og:url" content="https://dcferreira.com/post/2023-03-08-ai-web-app/"><meta property="og:title" content="Making and Deploying an AI Web App in 2023 (Part 8) | Daniel C Ferreira <dcferreira>"><meta property="og:description" content="How to deploy a serverless AI app to Google Cloud almost for free using Cloud Run and the Artifact Registry."><meta property="og:image" content="https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_512x512_fill_lanczos_center_3.png"><meta property="twitter:image" content="https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2023-03-08T00:08:00+00:00"><meta property="article:modified_time" content="2023-03-08T00:08:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://dcferreira.com/post/2023-03-08-ai-web-app/"},"headline":"Making and Deploying an AI Web App in 2023 (Part 8)","datePublished":"2023-03-08T00:08:00Z","dateModified":"2023-03-08T00:08:00Z","author":{"@type":"Person","name":"Daniel C. Ferreira"},"publisher":{"@type":"Organization","name":"Daniel C Ferreira \u003cdcferreira\u003e","logo":{"@type":"ImageObject","url":"https://dcferreira.com/media/icon_hu4876d3cb97a4ad0b3222b8f65edef0fe_436070_192x192_fill_lanczos_center_3.png"}},"description":"How to deploy a serverless AI app to Google Cloud almost for free using Cloud Run and the Artifact Registry."}</script><title>Making and Deploying an AI Web App in 2023 (Part 8) | Daniel C Ferreira &lt;dcferreira></title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class="page-wrapper dark" data-wc-page-id=ab684eceb3ecc9662d3785b82f7cfc16><script src=/js/wowchemy-init.min.6c07fd79b08c404df0504bd310968f2f.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><header class=header--fixed><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#experience><span>Experience</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Making and Deploying an AI Web App in 2023 (Part 8)</h1><p class=page-subtitle>Deploy a Serverless AI App with Google Cloud</p><div class=article-metadata><div></div><span class=article-date>Mar 8, 2023</span>
<span class=middot-divider></span>
<span class=article-reading-time>4 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/ai/>AI</a>, <a href=/category/nlp/>NLP</a></span></div></div><div class=article-container><div class=article-style><div class="alert alert-note"><div><p>This is part of a multi-part blogpost about how to build an AI Web App.
Please refer to <a href=/post/2023-03-01-ai-web-app>Part 1</a> for more context.</p><p>This post uses <a href=https://cloud.google.com/run target=_blank rel=noopener>Google&rsquo;s Cloud Run</a>.
Alternatives would be <a href=https://aws.amazon.com/lambda/ target=_blank rel=noopener>AWS&rsquo;s Lambda</a>, <a href=https://learn.microsoft.com/en-us/azure/azure-functions/functions-overview target=_blank rel=noopener>Azure Functions</a>.</p></div></div><p>It&rsquo;s finally time to deploy our web app so that everyone can reach it.
We&rsquo;ll deploy our app in a <a href=https://en.wikipedia.org/wiki/Serverless_computing target=_blank rel=noopener>serverless</a> fashion.
This means that every time someone makes a request, a new container will be
started and run only for the needed time to respond to it.
By doing it this way, we avoid wasting money on compute when no one is making requests to our server.
Furthermore, scaling happens automatically: if suddenly our web app gets very popular, our cloud
provider automatically starts as many containers as needed.</p><p>In this post we&rsquo;ll do everything with the <a href=https://cloud.google.com/sdk/gcloud target=_blank rel=noopener><code>gcloud</code> CLI</a>,
but it can all be done with the graphical interface of the
<a href=https://console.cloud.google.com/ target=_blank rel=noopener>Google Cloud Console website</a>.</p><h1 id=setup>Setup</h1><p>The first step is to <a href=https://cloud.google.com/sdk/docs/install target=_blank rel=noopener>install the <code>gcloud</code> CLI</a>
and run <code>gcloud init</code> to configure your account.</p><p>Then we need the following setup steps:</p><ol><li><p>Create a new project</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud projects create my-example-webapp-23867 --name<span class=o>=</span><span class=s2>&#34;AI Web App&#34;</span>
</span></span></code></pre></div><p>Note that the project ID (<code>my-example-webapp-23867</code>) needs to be unique.
So this exact command won&rsquo;t work for you, you will need to create your own project ID.</p></li><li><p>Configure <code>gcloud</code> to use your project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud config <span class=nb>set</span> project my-example-webapp-23867
</span></span></code></pre></div></li><li><p>Activate the <a href=https://cloud.google.com/run/docs/reference/rest target=_blank rel=noopener>Cloud Run API</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud services <span class=nb>enable</span> run.googleapis.com
</span></span></code></pre></div></li><li><p>Activate the <a href=https://cloud.google.com/artifact-registry target=_blank rel=noopener>Artifact Registry API</a>,
which we will use to upload our docker images.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud services <span class=nb>enable</span> artifactregistry.googleapis.com
</span></span></code></pre></div><p>Note that this step requires that billing is enabled in the project.
This step is not strictly required: you could upload the docker images somewhere else,
such as <a href=https://hub.docker.com/ target=_blank rel=noopener>docker hub</a>.</p><p>To activate billing for the project, first set up a billing account on the <a href=https://console.cloud.google.com/ target=_blank rel=noopener>Google Cloud Console</a>.
Using the CLI, you can list the existing billing accounts:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud billing accounts list
</span></span></code></pre></div><p>You can then link the project to a specific billing account</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud billing projects link my-example-webapp-23867 --billing-account 0X0X0X-0X0X0X-0X0X0X
</span></span></code></pre></div><p>(don&rsquo;t forget to replace the billing account ID by your own)</p></li><li><p>Create a new artifacts repository</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud artifacts repositories create ai-web-app-artifacts --repository-format<span class=o>=</span>docker --location<span class=o>=</span>us-central1 --description<span class=o>=</span><span class=s2>&#34;Docker artifacts&#34;</span>
</span></span></code></pre></div><p>Choose the location that is closer to you and your users.</p><p>Setup your docker client to authenticate to this repo with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud auth configure-docker us-central1-docker.pkg.dev
</span></span></code></pre></div><p>If you chose something else than <code>us-central1</code> for the location in the last step, be sure to reflect that in this auth command.
For example, if your region is <code>europe-west1</code>, you would instead run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud auth configure-docker europe-west1-docker.pkg.dev
</span></span></code></pre></div></li></ol><h1 id=deploy>Deploy</h1><p>By this point, we&rsquo;ve done all the necessary setup to deploy our app.
Now all that&rsquo;s left is to upload our docker image and start our serverless function.</p><p>We should add a helper script in <code>pyproject.toml</code> to push our image to Google Cloud:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>tool</span><span class=p>.</span><span class=nx>hatch</span><span class=p>.</span><span class=nx>envs</span><span class=p>.</span><span class=nx>default</span><span class=p>.</span><span class=nx>scripts</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>push</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;docker tag ai-web-app:latest us-central1-docker.pkg.dev/my-example-webapp-23867/ai-web-app-artifacts/ai-web-app:latest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;docker push us-central1-docker.pkg.dev/my-example-webapp-23867/ai-web-app-artifacts/ai-web-app:latest&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>We can then build and push our docker image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hatch run build <span class=o>&amp;&amp;</span> hatch run push
</span></span></code></pre></div><p>And finally we can deploy our serverless function (when asked, choose unauthenticated access)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gcloud run deploy ai-web-app --image<span class=o>=</span><span class=s2>&#34;us-central1-docker.pkg.dev/my-example-webapp-23867/ai-web-app-artifacts/ai-web-app:latest&#34;</span> --region<span class=o>=</span>us-central1 --memory<span class=o>=</span>2Gi
</span></span></code></pre></div><p>Note that the <code>--memory=2Gi</code> option is important for this specific case,
as the <code>all-MiniLM-L6-v2</code> model (see <a href=/post/2023-03-01-ai-web-app>Part 1</a>) requires almost all that memory to run.</p><p>The output of this deploy command will give you a Service URL for your app, which you should use
to access it.</p><p>The app should now be up (if it&rsquo;s not, have a look at the Cloud Run logs for errors),
and you can reach it with</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X GET <span class=s2>&#34;https://&lt;SERVICE-URL&gt;/search?query=risk%20factors&#34;</span>
</span></span></code></pre></div><div class="alert alert-warning"><div><p>About keeping your budget low:</p><ul><li>If you setup your Cloud Run function without authentication, it&rsquo;s a good idea
to set <a href=https://cloud.google.com/billing/docs/how-to/budgets target=_blank rel=noopener>budget limits</a>
and avoid unpleasant billing surprises.</li><li>If you&rsquo;re pushing many images to the Artifact Registry, the costs can also quickly
add up.
You should regularly delete old images, or create a
<a href=https://cloud.google.com/artifact-registry/docs/repositories/cleanup-policy target=_blank rel=noopener>cleanup policy</a>.</li></ul></div></div><p>To continue this tutorial, go to <a href=/post/2023-03-09-ai-web-app>Part 9</a>.</p></div><div class=article-tags><a class="badge badge-light" href=/tag/ai/>AI</a>
<a class="badge badge-light" href=/tag/machine-learning/>Machine Learning</a>
<a class="badge badge-light" href=/tag/web-app/>Web App</a>
<a class="badge badge-light" href=/tag/txtai/>txtai</a>
<a class="badge badge-light" href=/tag/web-development/>Web Development</a>
<a class="badge badge-light" href=/tag/serverless/>Serverless</a>
<a class="badge badge-light" href=/tag/nlp/>NLP</a></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.3d946de2e8784a477845261d87025092.js></script>
<script src=https://cdn.jsdelivr.net/gh/desandro/imagesloaded@v4.1.4/imagesloaded.pkgd.min.js integrity="sha512-S5PZ9GxJZO16tT9r3WJp/Safn31eu8uWrzglMahDT4dsmgqWonRY9grk3j+3tfuPr9WJNsfooOR7Gi7HL5W2jw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/metafizzy/isotope@v3.0.6/dist/isotope.pkgd.min.js integrity="sha512-Zq2BOxyhvnRFXu0+WE6ojpZLOU2jdnqbrM1hmVdGzyeCa1DgM3X5Q4A/Is9xA1IkbUeDd7755dNNI/PzSf2Pew==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/highlight.min.js integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/r.min.js crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.1/build/languages/latex.min.js crossorigin=anonymous></script>
<script id=search-hit-fuse-template type=text/x-template>
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.e8fd2d733eef6a8bbbe0539398fc0547.js type=module></script>
<script src=/en/js/wowchemy.min.9162604ef5b82e6fdeff386200ab6db9.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.b0d291ed6d27eacec233e6cf5204f99a.js type=module></script></body></html>